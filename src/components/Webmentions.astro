---
/**
 * Webmentions Component
 * Displays webmentions (likes, reposts, replies) for a blog post
 * Reads from generated webmentions.json
 */

import webmentionsData from '@data/webmentions.json';

interface Props {
    url: string;
    className?: string;
}

const { url, className = '' } = Astro.props;

// Filter webmentions for this URL
const mentions = webmentionsData.mentions.filter(
    (mention) => mention['wm-target'] === url || mention['mention-of'] === url
);

// Group by type
const likes = mentions.filter((m) => m['wm-property'] === 'like-of');
const reposts = mentions.filter((m) => m['wm-property'] === 'repost-of');
const replies = mentions.filter(
    (m) => m['wm-property'] === 'in-reply-to' || m['wm-property'] === 'mention-of'
);

const hasWebmentions = mentions.length > 0;
---

{
    hasWebmentions && (
        <section class={`webmentions mt-16 pt-8 border-t-2 border-neutral-200 ${className}`}>
            <h2 class="text-xl font-bold mb-6 text-neutral-800">
                <span class="mr-2">üí¨</span>
                Webmentions
            </h2>

            {/* Stats Summary */}
            <div class="flex gap-6 mb-8 text-sm">
                {likes.length > 0 && (
                    <div class="flex items-center gap-2">
                        <span class="text-2xl" aria-hidden="true">
                            ‚ù§Ô∏è
                        </span>
                        <span class="text-neutral-600">{likes.length} likes</span>
                    </div>
                )}
                {reposts.length > 0 && (
                    <div class="flex items-center gap-2">
                        <span class="text-2xl" aria-hidden="true">
                            üîÑ
                        </span>
                        <span class="text-neutral-600">{reposts.length} reposts</span>
                    </div>
                )}
                {replies.length > 0 && (
                    <div class="flex items-center gap-2">
                        <span class="text-2xl" aria-hidden="true">
                            üí¨
                        </span>
                        <span class="text-neutral-600">{replies.length} replies</span>
                    </div>
                )}
            </div>

            {/* Replies */}
            {replies.length > 0 && (
                <div class="space-y-6">
                    <h3 class="text-lg font-bold text-neutral-700 mb-4">Replies</h3>
                    {replies.map((reply: any) => {
                        const publishedDate = reply.published
                            ? new Date(reply.published).toLocaleDateString('en-US', {
                                  year: 'numeric',
                                  month: 'short',
                                  day: 'numeric'
                              })
                            : '';

                        return (
                            <article class="flex gap-4 p-4 bg-neutral-50 rounded-lg">
                                {reply.author.photo && (
                                    <img
                                        src={reply.author.photo}
                                        alt={reply.author.name}
                                        class="w-12 h-12 rounded-full flex-shrink-0"
                                    />
                                )}
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-baseline gap-2 mb-2">
                                        {reply.author.url ? (
                                            <a
                                                href={reply.author.url}
                                                class="font-medium text-neutral-800 hover:text-blue"
                                                target="_blank"
                                                rel="noopener noreferrer"
                                            >
                                                {reply.author.name}
                                            </a>
                                        ) : (
                                            <span class="font-medium text-neutral-800">
                                                {reply.author.name}
                                            </span>
                                        )}
                                        {publishedDate && (
                                            <span class="text-xs text-neutral-500">{publishedDate}</span>
                                        )}
                                    </div>
                                    {reply.content && reply.content.text && (
                                        <div class="prose prose-sm max-w-none text-neutral-700">
                                            <p>{reply.content.text.slice(0, 500)}{reply.content.text.length > 500 ? '...' : ''}</p>
                                        </div>
                                    )}
                                    <a
                                        href={reply.url}
                                        class="text-xs text-blue hover:underline mt-2 inline-block"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                    >
                                        View original ‚Üí
                                    </a>
                                </div>
                            </article>
                        );
                    })}
                </div>
            )}

            {/* Webmention Info */}
            <div class="mt-8 p-4 bg-blue-light border-l-4 border-blue rounded text-sm">
                <p class="text-neutral-700">
                    Mention this post on your website or social media, and it will show up here via{' '}
                    <a
                        href="https://webmention.io"
                        class="text-blue hover:underline"
                        target="_blank"
                        rel="noopener noreferrer"
                    >
                        Webmention
                    </a>
                    .
                </p>
            </div>
        </section>
    )
}
