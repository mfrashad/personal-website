---
import Layout from '@layouts/Layout.astro';
import Grid from '@components/Grid.astro';
import GridBox from '@components/GridBox.astro';
import GrowthStageIndicator from '@mdx/GrowthStageIndicator.astro';
import { getCollection } from 'astro:content';
import topicsData from '@data/topics.json';

export async function getStaticPaths() {
    return topicsData.topics.map((topic) => ({
        params: { topic: topic.name },
        props: { topicData: topic }
    }));
}

const { topic } = Astro.params;
const { topicData } = Astro.props;

// Get full content entries for posts in this topic
const allBlog = await getCollection('blog');
const allEssays = await getCollection('essays');
const allNotes = await getCollection('notes');

const allContent = [...allBlog, ...allEssays, ...allNotes];

// Filter to posts in this topic
const topicPosts = topicData.posts
    .map((postRef) => {
        return allContent.find(
            (entry) =>
                entry.slug === postRef.slug ||
                entry.data.title.toLowerCase().replace(/\s+/g, '-') === postRef.slug
        );
    })
    .filter((entry): entry is typeof allContent[number] => entry !== undefined);
---

<Layout
    title={`${topic} | Topics | Rashad`}
    description={`Browse ${topicPosts.length} posts about ${topic}`}
>
    <Grid>
        <GridBox desktopFull classes="pt-40 lg:pt-28 pb-32">
            <div class="mx-auto w-full max-w-[960px]">
                <a href="/topics" class="mb-8 block text-sm text-blue hover:underline">
                    ← All Topics
                </a>

                <h1 class="mb-2 text-2xl font-bold md:text-3xl">
                    <span class="text-neutral-400">#</span>{topic}
                </h1>
                <p class="mb-12 text-lg text-neutral-600">
                    {topicPosts.length} {topicPosts.length === 1 ? 'post' : 'posts'}
                </p>

                {
                    topicPosts.length === 0 ? (
                        <div class="text-center py-16">
                            <p class="text-neutral-500 text-lg">No posts found for this topic.</p>
                        </div>
                    ) : (
                        <div class="space-y-6">
                            {topicPosts.map((entry) => {
                                const formattedDate = entry.data.date.toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric'
                                });

                                const postUrl = `/${entry.collection}/${entry.slug}`;

                                return (
                                    <article class="p-6 bg-neutral-50 border border-neutral-200 rounded-lg hover:shadow-md transition-shadow">
                                        <div class="flex items-start justify-between gap-4 mb-3">
                                            <h2 class="text-xl font-bold">
                                                <a
                                                    href={postUrl}
                                                    class="text-neutral-800 hover:text-blue transition-colors"
                                                >
                                                    {entry.data.title}
                                                </a>
                                            </h2>
                                            {entry.data.growthStage && (
                                                <GrowthStageIndicator
                                                    stage={entry.data.growthStage}
                                                    className="flex-shrink-0"
                                                />
                                            )}
                                        </div>

                                        <div class="flex items-center gap-4 mb-3 text-sm text-neutral-600">
                                            <span>{formattedDate}</span>
                                            <span class="text-neutral-400">•</span>
                                            <span class="capitalize">{entry.collection}</span>
                                        </div>

                                        {entry.data.description && (
                                            <p class="text-neutral-700 mb-4">{entry.data.description}</p>
                                        )}

                                        {entry.data.tags && entry.data.tags.length > 0 && (
                                            <div class="flex gap-2 flex-wrap">
                                                {entry.data.tags.map((tag) => (
                                                    <a
                                                        href={`/topics/${encodeURIComponent(tag)}`}
                                                        class="text-xs px-2 py-1 bg-neutral-100 text-neutral-600 rounded hover:bg-blue-light hover:text-blue transition-colors"
                                                    >
                                                        #{tag}
                                                    </a>
                                                ))}
                                            </div>
                                        )}
                                    </article>
                                );
                            })}
                        </div>
                    )
                }
            </div>
        </GridBox>
    </Grid>
</Layout>
