---
import Layout from '@layouts/Layout.astro';
import Grid from '@components/Grid.astro';
import GridBox from '@components/GridBox.astro';
import SectionContent from '@components/SectionContent.astro';
import PostcardItem from '@components/PostcardItem.astro';
import WorldMapDetail from '@components/WorldMapDetail.astro';
import NewSlider from '@components/newSlider/NewSlider.astro';
import NewSliderItem from '@components/newSlider/NewSliderItem.astro';
import TagCloud from '@components/TagCloud.astro';
import Headline from '@components/Headline.astro';
import { Image } from 'astro:assets';
import RobinCoffee from '@assets/images/robin-coffee.png';
import NewPostcardSticker from '@assets/new-postcard.svg';
import { mockPostcards } from '@data/mockPostcards';
import { isValidCountry, getCountryFlag, getStandardCountryName } from '@utils/countries';

// Convert mock data to proper format with Date objects
const postcards = mockPostcards.map(p => ({
    ...p,
    date: new Date(p.date)
})).sort((a, b) => b.date.getTime() - a.date.getTime());

// Extract unique countries and count them
const allCountries = postcards
    .map((postcard) => postcard.country)
    .filter((country) => country !== null && country !== undefined);

// Process countries: normalize case, validate, and standardize names
const countryCounts = allCountries.reduce(
    (acc, country) => {
        if (isValidCountry(country!)) {
            const standardName = getStandardCountryName(country!);
            acc[standardName] = (acc[standardName] || 0) + 1;
        }
        return acc;
    },
    {} as Record<string, number>
);

const countryCloudData = Object.entries(countryCounts).map(([name, count]) => ({
    name,
    count,
    flag: getCountryFlag(name)
}));

const visitedCountries = countryCloudData.map((country) => country.name);
---

<Layout title="Postcards" description="Virtual postcards from visitors around the world">
    <SectionContent
        classes="w-full pt-40"
        title="Postcards"
        linkText="Send Postcard"
        linkUrl="/postcards/new"
        buttonStyle={true}
    >
        I love the idea of people stopping by and leaving a trace — something small that makes this
        website feel a little more alive. It's like a guestbook, just a bit more personal.
    </SectionContent>

    <Grid classes="mt-16">
        <GridBox desktopFull>
            <TagCloud
                tags={countryCloudData}
                basePath="/postcards"
                filterPath="country"
                filterLabel="country"
                total={postcards.length}
            />
        </GridBox>
    </Grid>

    <div class="mb-8 sm:mb-32">
        <NewSlider>
            {postcards.map((postcard) => (
                <NewSliderItem
                    largeFraction={2}
                    mediumFraction={1.25}
                    smallFraction={1}
                    classes="py-4"
                >
                    <PostcardItem
                        author={postcard.author}
                        body={postcard.body}
                        date={postcard.date}
                        country={postcard.country}
                        websiteUrl={postcard.websiteUrl}
                        paperColor={postcard.paperColor}
                        penColor={postcard.penColor}
                        stampSvg={postcard.stampSvg}
                    />
                </NewSliderItem>
            ))}
        </NewSlider>
    </div>

    <div class="pb-24">
        <Grid>
            <GridBox
                desktopStart={3}
                desktopEnd={5}
                tabletStart={1}
                tabletEnd={3}
                classes="flex items-center justify-center lg:justify-start mt-12 md:mt-0"
            >
                <Image
                    src={RobinCoffee}
                    alt="Illustration of me with coffee"
                    widths={[640]}
                    sizes={`320px`}
                    class="max-w-[140px]"
                />
            </GridBox>
            <GridBox
                desktopStart={6}
                desktopEnd={10}
                tabletStart={4}
                tabletEnd={7}
                classes="flex flex-col justify-center -mt-20"
            >
                <a href="/postcards/new" class="text-center self-end mr-6 z-10">
                    <Image
                        src={NewPostcardSticker}
                        alt="New postcard sticker"
                        widths={[240]}
                        sizes={`240px`}
                        class="max-w-[100px]"
                    />
                </a>
                <div class="mt-4 md:-mt-8">
                    <Headline level={3}>Drop me a line</Headline>
                    <p class="mt-2 md:mt-6">
                        A quiet way to say hello, and a reminder that there are people out there
                        reading, visiting, connecting — even if just for a moment. Feel free to
                        leave a postcard!
                    </p>
                </div>
            </GridBox>
        </Grid>
    </div>

    <div class="pb-16 hidden md:block">
        <Grid>
            <GridBox desktopFull>
                <WorldMapDetail visitedCountries={visitedCountries} />
            </GridBox>
        </Grid>
    </div>

    <!-- SVG Filters for distortion effects -->
    <svg width="0" height="0" class="hidden">
        <defs>
            <filter id="distort-xl">
                <feTurbulence baseFrequency="0.01" numOctaves="3" result="turbulence" seed="2" />
                <feDisplacementMap
                    in="SourceGraphic"
                    in2="turbulence"
                    scale="3"
                    xChannelSelector="R"
                    yChannelSelector="G"
                />
            </filter>
        </defs>
    </svg>
</Layout>
